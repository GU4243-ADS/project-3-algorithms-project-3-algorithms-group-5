---
title: "neighbors"
author: "Minzi Keem"
date: "4/8/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Step 1: Load matrices of similarity weights
```{r}
#for MS data
load("../output/MS_sim.RData")
load("../output/movie_sim.RData")
load("../output/MS_UI.RData")
load("../output/movie_UI.RData")
load("../output/MS_pred.RData")
load("../output/movie_pred.RData")
load("../output/MS_UI_test.RData")
load("../output/movie_UI_test.RData")
dim(MS_sim)
dim(movie_sim)
```

```{r}
install.packages("Metrics")
install.packages("caret")
```

```{r}
library(Metrics)
library(caret)
```

Please note, once the RData files are loaded, MS_UI is a matrix named MS_UI_matrix, and MS_UI_test is a matrix named MS_UI. 

### Step 2: Filtering the data by minimum threshold only

## a. MS: Select neighbors by setting minimum threshold for MS weights to 0.1, 0.2, 0.3, 0.4, and 0.5.

Any weights that are less than the minimum threshold are set to 0.
```{r}
MS_corr0.1 <- matrix(MS_sim, ncol = dim(MS_sim)[1])
MS_corr0.1[abs(MS_corr0.1) < 0.1] <- 0

MS_corr0.2 <- matrix(MS_sim, ncol = dim(MS_sim)[1])
MS_corr0.2[abs(MS_corr0.2) < 0.2] <- 0

MS_corr0.3 <- matrix(MS_sim, ncol = dim(MS_sim)[1])
MS_corr0.3[abs(MS_corr0.3) < 0.3] <- 0

MS_corr0.4 <- matrix(MS_sim, ncol = dim(MS_sim)[1])
MS_corr0.4[abs(MS_corr0.4) < 0.4] <- 0

MS_corr0.5 <- matrix(MS_sim, ncol = dim(MS_sim)[1])
MS_corr0.5[abs(MS_corr0.5) < 0.5] <- 0
```

## b. movie: Select neighbors by setting minimum threshold for movie weights to 0.1, 0.2, 0.3, 0.4, and 0.5.

Any weights that are less than the minimum threshold are set to 0.
```{r}
movie_corr0.1 <- matrix(movie_sim, ncol = dim(movie_sim)[1])
movie_corr0.1[abs(movie_corr0.1) < 0.1] <- 0

movie_corr0.2 <- matrix(movie_sim, ncol = dim(movie_sim)[1])
movie_corr0.2[abs(movie_corr0.2) < 0.2] <- 0

movie_corr0.3 <- matrix(movie_sim, ncol = dim(movie_sim)[1])
movie_corr0.3[abs(movie_corr0.3) < 0.3] <- 0

movie_corr0.4 <- matrix(movie_sim, ncol = dim(movie_sim)[1])
movie_corr0.4[abs(movie_corr0.4) < 0.4] <- 0

movie_corr0.5 <- matrix(movie_sim, ncol = dim(movie_sim)[1])
movie_corr0.5[abs(movie_corr0.5) < 0.5] <- 0
```


### Step 3: Filtering the data by minimum threshold and setting the number of closest neighbors to an absolute value 

## a. Function to return the position of the n largest values of matrix m, column p. We will use these indices to eventually filter out anything that is not the top n highest correlated users.

```{r}
nlargest <- function(m, n, p) {
  res <- order(m[p, ], decreasing = TRUE)[seq_len(n)];
  pos <- arrayInd(res, dim(m), useNames = TRUE);
  return(pos)
}
```

## b. MS: selecting 20 top correlated neighbors and 40 top correlated neighbors
```{r}
# 20 neighbors
MS_corr0.1_nnbors20 <- matrix(MS_sim, ncol = dim(MS_sim)[1])
MS_corr0.1_nnbors20[abs(MS_corr0.1_nnbors20) < 0.1] <- 0

#temporarily set the diagonals to NA while we find highest correlations; otherwise, the highest correlated in any row will be 1.
diag(MS_corr0.1_nnbors20) <- NA
test <- matrix(0, ncol = dim(MS_sim)[1], nrow = dim(MS_sim)[1])

for (i in 1:ncol(MS_corr0.1_nnbors20)){
  temp <- nlargest(MS_corr0.1_nnbors20, 20, i)[, 1]
  test[temp, i] <- MS_corr0.1_nnbors20[temp, i]
}

#set the diagonals back to 1
diag(test) <- 1
MS_corr0.1_nnbors20 <- test



# 40 neighbors
MS_corr0.1_nnbors40 <- matrix(MS_sim, ncol = dim(MS_sim)[1])
MS_corr0.1_nnbors40[abs(MS_corr0.1_nnbors40) < 0.1] <- 0

#temporarily set the diagonals to NA while we find highest correlations; otherwise, the highest correlated in any row will be 1.
diag(MS_corr0.1_nnbors40) <- NA
test <- matrix(0, ncol = dim(MS_sim)[1], nrow = dim(MS_sim)[1])

for (i in 1:ncol(MS_corr0.1_nnbors40)){
  temp <- nlargest(MS_corr0.1_nnbors40, 40, i)[, 1]
  test[temp, i] <- MS_corr0.1_nnbors40[temp, i]
}

#set the diagonals back to 1
diag(test) <- 1
MS_corr0.1_nnbors40 <- test
```

## c. movie: selecting 20 top correlated neighbors and 40 top correlated neighbors
```{r}
# 20 neighbors
movie_corr0.1_nnbors20 <- matrix(movie_sim, ncol = dim(movie_sim)[1])
movie_corr0.1_nnbors20[abs(movie_corr0.1_nnbors20) < 0.1] <- 0

#temporarily set the diagonals to NA while we find highest correlations; otherwise, the highest correlated in any row will be 1.
diag(movie_corr0.1_nnbors20) <- NA
test <- matrix(0, ncol = dim(movie_sim)[1], nrow = dim(movie_sim)[1])

for (i in 1:ncol(movie_corr0.1_nnbors20)){
  temp <- nlargest(movie_corr0.1_nnbors20, 20, i)[, 1]
  test[temp, i] <- movie_corr0.1_nnbors20[temp, i]
}

#set the diagonals back to 1
diag(test) <- 1
movie_corr0.1_nnbors20 <- test



# 40 neighbors
movie_corr0.1_nnbors40 <- matrix(movie_sim, ncol = dim(movie_sim)[1])
movie_corr0.1_nnbors40[abs(movie_corr0.1_nnbors40) < 0.1] <- 0

#temporarily set the diagonals to NA while we find highest correlations; otherwise, the highest correlated in any row will be 1.
diag(movie_corr0.1_nnbors40) <- NA
test <- matrix(0, ncol = dim(movie_sim)[1], nrow = dim(movie_sim)[1])

for (i in 1:ncol(movie_corr0.1_nnbors40)){
  temp <- nlargest(movie_corr0.1_nnbors40, 40, i)[, 1]
  test[temp, i] <- movie_corr0.1_nnbors40[temp, i]
}

#set the diagonals back to 1
diag(test) <- 1
movie_corr0.1_nnbors40 <- test

# 60 neighbors
movie_corr0.1_nnbors60 <- matrix(movie_sim, ncol = dim(movie_sim)[1])
movie_corr0.1_nnbors60[abs(movie_corr0.1_nnbors60) < 0.1] <- 0

#temporarily set the diagonals to NA while we find highest correlations; otherwise, the highest correlated in any row will be 1.
diag(movie_corr0.1_nnbors60) <- NA
test <- matrix(0, ncol = dim(movie_sim)[1], nrow = dim(movie_sim)[1])

for (i in 1:ncol(movie_corr0.1_nnbors60)){
  temp <- nlargest(movie_corr0.1_nnbors60, 60, i)[, 1]
  test[temp, i] <- movie_corr0.1_nnbors60[temp, i]
}

#set the diagonals back to 1
diag(test) <- 1
movie_corr0.1_nnbors60 <- test
```

### Step 4: Get the prediction matrix for all filtered datasets
```{r}
source("../lib/functions.R")
```

## a. MS
```{r}
MS_corr0.1_pred <- pred_matrix(MS_UI_matrix, MS_corr0.1)
MS_corr0.2_pred <- pred_matrix(MS_UI_matrix, MS_corr0.2)
MS_corr0.3_pred <- pred_matrix(MS_UI_matrix, MS_corr0.3)
MS_corr0.4_pred <- pred_matrix(MS_UI_matrix, MS_corr0.4)
MS_corr0.5_pred <- pred_matrix(MS_UI_matrix, MS_corr0.5)
MS_corr0.1_nnbors20_pred <- pred_matrix(MS_UI_matrix, MS_corr0.1_nnbors20)
MS_corr0.1_nnbors40_pred <- pred_matrix(MS_UI_matrix, MS_corr0.1_nnbors40)
```

## b. movie
```{r}
movie_corr0.1_pred <- pred_matrix(movie_UI, movie_corr0.1)
movie_corr0.2_pred <- pred_matrix(movie_UI, movie_corr0.2)
movie_corr0.3_pred <- pred_matrix(movie_UI, movie_corr0.3)
movie_corr0.4_pred <- pred_matrix(movie_UI, movie_corr0.4)
movie_corr0.5_pred <- pred_matrix(movie_UI, movie_corr0.5)
movie_corr0.1_nnbors20_pred <- pred_matrix(movie_UI, movie_corr0.1_nnbors20)
movie_corr0.1_nnbors40_pred <- pred_matrix(movie_UI, movie_corr0.1_nnbors40)
movie_corr0.1_nnbors60_pred <- pred_matrix(movie_UI, movie_corr0.1_nnbors60)
```

### Step 5: Get the MAE for the different neighborhood selections
```{r}
source("../lib/evaluation.R")
```

## a. MS
```{r}
MSmae <- c(eva_mae(MS_corr0.1_pred, MS_UI), eva_mae(MS_corr0.2_pred, MS_UI), eva_mae(MS_corr0.3_pred, MS_UI), eva_mae(MS_corr0.4_pred, MS_UI), eva_mae(MS_corr0.5_pred, MS_UI), eva_mae(MS_corr0.1_nnbors20_pred, MS_UI), eva_mae(MS_corr0.1_nnbors40_pred, MS_UI))

MSmae
```

## b. movie
```{r, warning = FALSE}
moviemae <- c(eva_mae(movie_corr0.1_pred, movie_UI_test), eva_mae(movie_corr0.2_pred, movie_UI_test), eva_mae(movie_corr0.3_pred, movie_UI_test), eva_mae(movie_corr0.4_pred, movie_UI_test), eva_mae(movie_corr0.5_pred, movie_UI_test), eva_mae(movie_corr0.1_nnbors20_pred, movie_UI_test), eva_mae(movie_corr0.1_nnbors40_pred, movie_UI_test))

moviemae
```

### Step 6: Calculate RMSE for the different neighborhood selections

## a. MS
```{r}
MSrmse <- c(eva_rmse(MS_corr0.1_pred, MS_UI), eva_rmse(MS_corr0.2_pred, MS_UI), eva_rmse(MS_corr0.3_pred, MS_UI), eva_rmse(MS_corr0.4_pred, MS_UI), eva_rmse(MS_corr0.5_pred, MS_UI), eva_rmse(MS_corr0.1_nnbors20_pred, MS_UI), eva_rmse(MS_corr0.1_nnbors40_pred, MS_UI))

MSrmse
```

## b. movie
```{r, warning = FALSE}
moviermse <- c(eva_rmse(movie_corr0.1_pred, movie_UI_test), eva_rmse(movie_corr0.2_pred, movie_UI_test), eva_rmse(movie_corr0.3_pred, movie_UI_test), eva_rmse(movie_corr0.4_pred, movie_UI_test), eva_rmse(movie_corr0.5_pred, movie_UI_test), eva_rmse(movie_corr0.1_nnbors20_pred, movie_UI_test), eva_rmse(movie_corr0.1_nnbors40_pred, movie_UI_test))

moviermse
```

### Step 7: Generate relevant figures and tables
```{r}
library(data.table)

MSres <- data.frame(MSmae, MSrmse)
names(MSres)[1] <- "MAE"
names(MSres)[2] <- "RMSE"
setattr(MSres, "row.names", c("Min Abs Corr = 0.1", "Min Abs Corr = 0.2", "Min Abs Corr = 0.3", "Min Abs Corr = 0.4", "Min Abs Corr = 0.5", "Min Abs Corr = 0.1, NNbors = 20", "Min Abs Corr = 0.1, NNbors = 40"))

movieres <- data.frame(moviemae, moviermse)
names(movieres)[1] <- "MAE"
names(movieres)[2] <- "RMSE"
setattr(movieres, "row.names", c("Min Abs Corr = 0.1", "Min Abs Corr = 0.2", "Min Abs Corr = 0.3", "Min Abs Corr = 0.4", "Min Abs Corr = 0.5", "Min Abs Corr = 0.1, NNbors = 20", "Min Abs Corr = 0.1, NNbors = 40"))

MSres
movieres
```












